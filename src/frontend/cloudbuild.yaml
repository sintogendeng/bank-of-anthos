steps:
# Build the container
- name: 'gcr.io/cloud-builders/docker'
  dir: 'src/frontend/'
  args: ["build", "-t", "gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:${COMMIT_SHA}", "-f", "Dockerfile", "."]
  # args: ["build", "-t", "gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:v1.1", "-f", "Dockerfile", "."]
# Push the container image
- name: 'gcr.io/cloud-builders/docker'
  dir: 'src/frontend/'
  args: ['push', 'gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:${COMMIT_SHA}']
  # args: ['push', 'gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:v1.1']
# Adjust the manifest
- name: 'gcr.io/cloud-builders/gcloud'
  id: Generate manifest
  entrypoint: /bin/sh
  args:
  - '-c'
  - |
     sed -i "s/APP_VERSION_COMMIT/${COMMIT_SHA}/g" dev-kubernetes-manifests/frontend.yaml
# Create release in Google Cloud Deploy
- name: "gcr.io/cloud-builders/gke-deploy"
  args: 
  - run
  - --filename=dev-kubernetes-manifests/frontend.yaml
  - --image=gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:${COMMIT_SHA}
  # - --image=gcr.io/$PROJECT_ID/github.com/sintogendeng/bank-of-anthos:v1.1
  - --location="asia-southeast1-a"
  - --cluster=gke-anthos